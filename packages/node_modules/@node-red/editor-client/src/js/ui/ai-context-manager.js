/**
 * AI Context Manager
 * Manages context optimization including system prompt caching
 */
RED.aiContextManager = (function() {
    var cache = {
        nodeTypes: null,
        nodeTypesHash: null,
        workspaceSummary: null,
        workspaceHash: null,
        systemPrompt: null,
        lastPaletteChange: null
    };

    /**
     * Create hash of node types for cache invalidation
     */
    function getNodeTypesHash(nodeTypes) {
        if (!nodeTypes) return null;
        var keys = Object.keys(nodeTypes).sort();
        return keys.join(',') + ':' + keys.length;
    }

    /**
     * Create hash of workspace for cache invalidation
     */
    function getWorkspaceHash(workspace) {
        if (!workspace || !Array.isArray(workspace)) return null;
        var ids = workspace.map(function(n) { return n.id; }).sort();
        return ids.join(',') + ':' + ids.length;
    }

    /**
     * Get cached node types or update cache
     */
    function getCachedNodeTypes(currentNodeTypes) {
        var currentHash = getNodeTypesHash(currentNodeTypes);
        
        // Check if cache is valid
        if (cache.nodeTypes && cache.nodeTypesHash === currentHash) {
            return cache.nodeTypes;
        }
        
        // Cache miss or invalid - update cache
        cache.nodeTypes = currentNodeTypes;
        cache.nodeTypesHash = currentHash;
        cache.systemPrompt = null; // Invalidate system prompt cache
        
        return cache.nodeTypes;
    }

    /**
     * Get cached workspace summary or create new one
     */
    function getCachedWorkspaceSummary(workspace) {
        var currentHash = getWorkspaceHash(workspace);
        
        // Check if cache is valid
        if (cache.workspaceSummary && cache.workspaceHash === currentHash) {
            return cache.workspaceSummary;
        }
        
        // Cache miss or invalid - create summary
        cache.workspaceSummary = workspace;
        cache.workspaceHash = currentHash;
        cache.systemPrompt = null; // Invalidate system prompt cache
        
        return cache.workspaceSummary;
    }

    /**
     * Invalidate all caches
     */
    function invalidateCache() {
        cache = {
            nodeTypes: null,
            nodeTypesHash: null,
            workspaceSummary: null,
            workspaceHash: null,
            systemPrompt: null,
            lastPaletteChange: null
        };
    }

    /**
     * Invalidate workspace cache only
     */
    function invalidateWorkspaceCache() {
        cache.workspaceSummary = null;
        cache.workspaceHash = null;
        cache.systemPrompt = null;
    }

    /**
     * Initialize event listeners for cache invalidation
     */
    function init() {
        // Listen for palette changes
        if (RED.events) {
            RED.events.on('palette:changed', function() {
                invalidateCache();
            });
            
            // Listen for workspace changes (flow modifications)
            RED.events.on('workspace:changed', function() {
                invalidateWorkspaceCache();
            });
            
            // Listen for node changes
            RED.events.on('nodes:add', invalidateWorkspaceCache);
            RED.events.on('nodes:remove', invalidateWorkspaceCache);
            RED.events.on('nodes:change', invalidateWorkspaceCache);
        }
    }

    return {
        getCachedNodeTypes: getCachedNodeTypes,
        getCachedWorkspaceSummary: getCachedWorkspaceSummary,
        invalidateCache: invalidateCache,
        invalidateWorkspaceCache: invalidateWorkspaceCache,
        init: init
    };
})();

