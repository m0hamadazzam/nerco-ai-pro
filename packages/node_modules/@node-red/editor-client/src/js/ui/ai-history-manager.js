/**
 * AI History Manager
 * Manages separate chat history for each model/provider combination
 */
RED.aiHistoryManager = (function() {
    var histories = {}; // { "provider:model:apiKeyId": [...] }
    var currentKey = null;

    /**
     * Generate history key from provider, model, and apiKeyId
     */
    function getHistoryKey(provider, model, apiKeyId) {
        if (!provider || !model || !apiKeyId) {
            return null;
        }
        return provider + ':' + model + ':' + apiKeyId;
    }

    /**
     * Get history for a specific model
     */
    function getHistory(provider, model, apiKeyId) {
        var key = getHistoryKey(provider, model, apiKeyId);
        if (!key) {
            return [];
        }
        
        if (!histories[key]) {
            histories[key] = [];
            // Load from localStorage if exists
            loadFromStorage(key);
        }
        
        return histories[key];
    }

    /**
     * Switch to a different model's history
     */
    function switchHistory(provider, model, apiKeyId) {
        var newKey = getHistoryKey(provider, model, apiKeyId);
        if (!newKey) {
            return [];
        }
        
        // Save current history before switching
        if (currentKey && currentKey !== newKey) {
            saveToStorage(currentKey);
        }
        
        // Switch to new history
        currentKey = newKey;
        
        // Load new history if not already loaded
        if (!histories[currentKey]) {
            histories[currentKey] = [];
            loadFromStorage(currentKey);
        }
        
        return histories[currentKey];
    }

    /**
     * Add a message to the current history
     */
    function addMessage(role, content, metadata) {
        if (!currentKey) {
            return;
        }
        
        var message = {
            role: role,
            content: content
        };
        
        // Add metadata if provided (e.g., isFlow, isUpdate)
        if (metadata) {
            Object.assign(message, metadata);
        }
        
        histories[currentKey].push(message);
        saveToStorage(currentKey);
    }

    /**
     * Clear history for a specific model
     */
    function clearHistory(provider, model, apiKeyId) {
        var key = getHistoryKey(provider, model, apiKeyId);
        if (key) {
            histories[key] = [];
            localStorage.removeItem('ai_history_' + key);
            
            // If clearing current history, reset currentKey
            if (currentKey === key) {
                currentKey = null;
            }
        }
    }

    /**
     * Get current history
     */
    function getCurrentHistory() {
        if (!currentKey || !histories[currentKey]) {
            return [];
        }
        return histories[currentKey];
    }

    /**
     * Get current history key
     */
    function getCurrentKey() {
        return currentKey;
    }

    /**
     * Load history from localStorage
     */
    function loadFromStorage(key) {
        try {
            var stored = localStorage.getItem('ai_history_' + key);
            if (stored) {
                var parsed = JSON.parse(stored);
                if (Array.isArray(parsed)) {
                    histories[key] = parsed;
                }
            }
        } catch (e) {
            console.warn('Failed to load history from storage:', e);
            histories[key] = [];
        }
    }

    /**
     * Save history to localStorage
     */
    function saveToStorage(key) {
        if (!histories[key]) {
            return;
        }
        
        try {
            // Limit stored history to last 100 messages to avoid localStorage size limits
            var toStore = histories[key].slice(-100);
            localStorage.setItem('ai_history_' + key, JSON.stringify(toStore));
        } catch (e) {
            console.warn('Failed to save history to storage:', e);
            // If storage is full, try storing less
            try {
                var toStore = histories[key].slice(-50);
                localStorage.setItem('ai_history_' + key, JSON.stringify(toStore));
            } catch (e2) {
                console.warn('Failed to save reduced history to storage:', e2);
            }
        }
    }

    /**
     * Get all history keys (for debugging/admin)
     */
    function getAllHistoryKeys() {
        return Object.keys(histories);
    }

    /**
     * Clear all histories
     */
    function clearAllHistories() {
        histories = {};
        currentKey = null;
        
        // Clear all from localStorage
        var keys = Object.keys(localStorage);
        keys.forEach(function(key) {
            if (key.startsWith('ai_history_')) {
                localStorage.removeItem(key);
            }
        });
    }

    return {
        getHistory: getHistory,
        switchHistory: switchHistory,
        addMessage: addMessage,
        clearHistory: clearHistory,
        getCurrentHistory: getCurrentHistory,
        getCurrentKey: getCurrentKey,
        getAllHistoryKeys: getAllHistoryKeys,
        clearAllHistories: clearAllHistories
    };
})();

